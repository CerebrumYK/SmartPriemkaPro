–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ
–Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É –≤–µ–±‚Äë–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
¬´–ü—Ä–∏—ë–º–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏¬ª
–í–µ—Ä—Å–∏—è: 1.0
–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: RU (–Ω–∞ –ø–µ—Ä–≤–æ–º —ç—Ç–∞–ø–µ)
–ú–æ–¥–µ–ª—å —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è: –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä/–í–ú (—Å –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–æ–π Azure)
–¶–µ–ª–µ–≤–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –∫–ª–∏–µ–Ω—Ç–∞: –¥–µ—Å–∫—Ç–æ–ø/–ø–ª–∞–Ω—à–µ—Ç (–≤ —Ç.—á. iPad), –º–æ–±–∏–ª—å–Ω—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–∞ –ø–µ—Ä–≤–æ–º —ç—Ç–∞–ø–µ: 1 —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç (–±–µ–∑ –º—É–ª—å—Ç–∏-—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç–∏)
________________________________________
1) –¶–µ–ª—å –∏ –∫–ª—é—á–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å
–°–æ–±—Ä–∞—Ç—å –µ–¥–∏–Ω–æ–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç:
‚Ä¢	–±—ã—Å—Ç—Ä–æ –Ω–∞—Ö–æ–¥–∏—Ç—å –∏ –æ—Ç–±–∏—Ä–∞—Ç—å –¥–µ—Ñ–µ–∫—Ç—ã —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞/—Ä–µ–º–æ–Ω—Ç–∞ –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º (—Å—Ç—Ä–∞–Ω–∞ ‚Üí –±–ª–æ–∫ ‚Üí —Ç–∏–ø, –ª–æ–∫–∞—Ü–∏—è, –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å, —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫);
‚Ä¢	–æ—Ç–º–µ—á–∞—Ç—å –Ω—É–∂–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ —á–µ–∫–±–æ–∫—Å–∞–º–∏, –¥–æ–ø–æ–ª–Ω—è—Ç—å –∏—Ö –∏–∑–º–µ—Ä–µ–Ω–∏—è–º–∏, –ø—Ä–∏–≤—è–∑–∫–∞–º–∏ –∫ –ª–æ–∫–∞—Ü–∏—è–º –∏ –Ω–æ—Ä–º–∞—Ç–∏–≤–∞–º;
‚Ä¢	—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç—ã —Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏/–≤—ã–¥–µ—Ä–∂–∫–∞–º–∏ –∏ —Ñ–æ—Ç–æ, —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ PDF/DOCX/XLSX;
‚Ä¢	—Ö—Ä–∞–Ω–∏—Ç—å –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –º–µ–¥–∏–∞—Ñ–∞–π–ª—ã (–≥–∞–ª–µ—Ä–µ—è: —Ç–µ–≥–∏, –ø–æ–¥–ø–∏—Å–∏, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞, –ø–∞–∫–µ—Ç–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ) —á–µ—Ä–µ–∑ Supabase Storage c Signed URLs.
–û—Ç–¥–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º:
‚Ä¢	–í—Å–µ –Ω–æ—Ä–º—ã (–†–ö/–†–§ –∏ –¥—Ä.) ‚Äî –≤ –æ–¥–Ω–æ–π –±–∞–∑–µ, –≤ –æ—Ç—á—ë—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã —Å—Å—ã–ª–∫–∏/—Ü–∏—Ç–∞—Ç—ã.
‚Ä¢	DOCX-—ç–∫—Å–ø–æ—Ä—Ç: –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–µ—Ñ–µ–∫—Ç–∞ –≤—Å—Ç–∞–≤–ª—è—Ç—å 2‚Äì3 —Ñ–æ—Ç–æ, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã.
‚Ä¢	–ì–∞–ª–µ—Ä–µ—è: —Ç–µ–≥–∏ –∏ –ø–æ–∏—Å–∫ –ø–æ —Ç–µ–≥–∞–º (¬´—Ç—Ä–µ—â–∏–Ω–∞¬ª, ¬´–æ–∫–Ω–æ¬ª, ¬´—Ä–∞–¥–∏–∞—Ç–æ—Ä¬ª –∏ —Ç.–ø.).
‚Ä¢	PWA/–æ—Ñ–ª–∞–π–Ω + Background Sync –¥–ª—è POST-–æ–ø–µ—Ä–∞—Ü–∏–π —Å –≤–∏–∑—É–∞–ª—å–Ω—ã–º–∏ —Å—Ç–∞—Ç—É—Å–∞–º–∏.
________________________________________
2) –†–æ–ª–∏ –∏ –¥–æ—Å—Ç—É–ø
‚Ä¢	–ì–æ—Å—Ç—å (anon): —Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ (—á–µ—Ä–µ–∑ RLS).
‚Ä¢	–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π (authenticated): —á—Ç–µ–Ω–∏–µ + –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–∑–º–µ—Ä–µ–Ω–∏–π, –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –¥–µ—Ñ–µ–∫—Ç–∞ (–∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å, –ª–æ–∫–∞—Ü–∏—è), –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ª–æ–∫–∞—Ü–∏–π, –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ –±–ª–æ–∫–æ–≤/—Ç–∏–ø–æ–≤.
‚Ä¢	–ê–¥–º–∏–Ω: —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞/–º–∏–≥—Ä–∞—Ü–∏–∏ (–≤–Ω–µ UI).
‚Ä¢	–ù–∞ –ø–µ—Ä–≤–æ–º —ç—Ç–∞–ø–µ: –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –±–µ–∑ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤/—Ä–µ–≤—å—é–µ—Ä–æ–≤ –∏ –±–µ–∑ ¬´–≤–ª–∞–¥–µ–ª—å—Ü–∞ –∑–∞–ø–∏—Å–∏¬ª.
________________________________________
3) –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫
‚Ä¢	Frontend/Backend: Next.js 15 (App Router), TypeScript, Tailwind CSS.
‚Ä¢	–ë–î/–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è: Supabase (Postgres + Auth + RLS).
‚Ä¢	–≠–∫—Å–ø–æ—Ä—Ç:
o	PDF: —Å–µ—Ä–≤–µ—Ä–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä —á–µ—Ä–µ–∑ Playwright/Puppeteer (–¥–ª—è –±–æ–ª—å—à–∏—Ö –≤—ã–±–æ—Ä–æ–∫).
o	DOCX: –ø–∞–∫–µ—Ç docx (—Å–µ—Ä–≤–µ—Ä–Ω—ã–π); –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ 2‚Äì3 —Ñ–æ—Ç–æ –Ω–∞ –¥–µ—Ñ–µ–∫—Ç.
o	XLSX: –ø–∞–∫–µ—Ç xlsx (—Å–µ—Ä–≤–µ—Ä).
‚Ä¢	–°–æ—Å—Ç–æ—è–Ω–∏–µ –≤—ã–±–æ—Ä–∞: localStorage.
‚Ä¢	PWA: –º–∞–Ω–∏—Ñ–µ—Å—Ç + —Å–µ—Ä–≤–∏—Å-–≤–æ—Ä–∫–µ—Ä + IndexedDB –¥–ª—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ –∏ –∫—ç—à–∞ GET.
‚Ä¢	–§—É–ª–ª-—Ç–µ–∫—Å—Ç –ø–æ–∏—Å–∫: PostgreSQL pg_trgm (+ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ).
________________________________________
4) –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env.local)
NEXT_PUBLIC_SUPABASE_URL=‚Ä¶              # –ü—É–±–ª–∏—á–Ω—ã–π URL
NEXT_PUBLIC_SUPABASE_ANON_KEY=‚Ä¶         # –¢–æ–ª—å–∫–æ anon key –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞
# –í–ê–ñ–ù–û: service_role –∫–ª—é—á —Ö—Ä–∞–Ω–∏—Ç—å –¢–û–õ–¨–ö–û –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π/—Å–∏–¥–æ–≤.
–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª –¥–æ—Å—Ç—É–ø—ã –æ—Ç–¥–µ–ª—å–Ω–æ; –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å service_role –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π/–∏–º–ø–æ—Ä—Ç–∞, –∑–∞—Ç–µ–º –∫–ª—é—á —Ä–æ—Ç–∏—Ä–æ–≤–∞—Ç—å.
________________________________________
5) –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö (Supabase / Postgres)
5.1 –¢–∞–±–ª–∏—Ü—ã (–æ—Å–Ω–æ–≤–Ω—ã–µ)
‚Ä¢	countries(id uuid PK, name text unique, is_enabled bool)
‚Ä¢	blocks(id uuid PK, name text unique)
‚Ä¢	defect_types(id uuid PK, block_id ‚Üí blocks.id, name text, unique(block_id,name))
‚Ä¢	norms(id uuid PK, country_id ‚Üí countries.id, code text, point text, source_url text, full_text text, unique(country_id,code,point))
‚Ä¢	severity_levels(id bigserial PK, name text unique, sort_order int) ‚Äî 4 —É—Ä–æ–≤–Ω—è (–ö—Ä–∏—Ç–∏—á–Ω–æ/–°—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ/–ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ/–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ)
‚Ä¢	location_categories(id uuid PK, name text unique) ‚Äî ¬´–ö–≤–∞—Ä—Ç–∏—Ä–∞¬ª, ¬´–ß–∞—Å—Ç–Ω—ã–π –¥–æ–º/–ö–æ—Ç—Ç–µ–¥–∂¬ª, ¬´–û—Ñ–∏—Å¬ª, ‚Ä¶
‚Ä¢	locations(id uuid PK, category_id ‚Üí location_categories.id, name text, unique(category_id,name))
‚Ä¢	defects(id uuid PK, country_id, block_id, type_id, problem text, description text, solution text, norm_id uuid, severity_id bigint, location_id uuid, created_at timestamptz default now())
o	—É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å (–¥–µ–¥—É–ø):
(country_id, block_id, type_id, problem, coalesce(norm_id,'00000000-0000-0000-0000-000000000000'))
‚Ä¢	defect_measurements(id bigserial PK, defect_id uuid ‚Üí defects.id, name text, value text, unit text, created_at timestamptz default now(), created_by uuid)
‚Ä¢	media_files(id uuid PK, project_id uuid, defect_id uuid?, location_id uuid?, path text, preview_path text?, exif jsonb?, tags text[], created_at timestamptz default now())
‚Ä¢	import_logs(id bigserial PK, source text, rows int, started_at timestamptz, finished_at timestamptz, details jsonb)
5.2 –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (–¥–ª—è UI)
‚Ä¢	defects_full_v2 ‚Äî —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–∞—è –∑–∞–ø–∏—Å—å –¥–µ—Ñ–µ–∫—Ç–∞: –∏–º–µ–Ω–∞ —Å—Ç—Ä–∞–Ω—ã/–±–ª–æ–∫–∞/—Ç–∏–ø–∞/–ª–æ–∫–∞—Ü–∏–π, –Ω–æ—Ä–º–∞ (–∫–æ–¥/–ø—É–Ω–∫—Ç/—Å—Å—ã–ª–∫–∞/–≤—ã–¥–µ—Ä–∂–∫–∞), –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å (–∏–º—è, –ø–æ—Ä—è–¥–æ–∫), —É–¥–æ–±–Ω—ã–π norm_display = code + point.
‚Ä¢	defects_view_v2 ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è –≤—ã–±–æ—Ä–∫–∞ –¥–ª—è —Å–ø–∏—Å–∫–∞/—Ç–∞–±–ª–∏—Ü—ã (—Å norm_display –∏ severity_order).
5.3 –ü–æ–ª–∏—Ç–∏–∫–∏ RLS
–í–∫–ª—é—á–µ–Ω—ã –Ω–∞ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö.
‚Ä¢	SELECT: –¥–æ—Å—Ç—É–ø–Ω—ã anon –∏ authenticated (read-only).
‚Ä¢	INSERT/UPDATE/DELETE:
o	defect_measurements ‚Äî —Ä–∞–∑—Ä–µ—à–∏—Ç—å authenticated –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏;
o	defects ‚Äî UPDATE (–∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å, –ª–æ–∫–∞—Ü–∏—è, problem/description/solution);
o	locations ‚Äî INSERT (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å —Å–≤–æ–∏ –ª–æ–∫–∞—Ü–∏–∏);
o	media_files ‚Äî INSERT (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ–¥–∏–∞/–º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö).
5.4 –ò–Ω–¥–µ–∫—Å—ã –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
‚Ä¢	–ò–Ω–¥–µ–∫—Å—ã –Ω–∞ –≤—Å–µ—Ö FK.
‚Ä¢	defects_dedupe_idx (—Å–º. –≤—ã—à–µ).
‚Ä¢	–î–ª—è —Ñ—É–ª–ª-—Ç–µ–∫—Å—Ç–∞: gin + pg_trgm –Ω–∞ (problem, description, solution, norm_display).
‚Ä¢	–ë—é–¥–∂–µ—Ç –æ—Ç–≤–µ—Ç–∞ —Å–ø–∏—Å–∫–∞: ‚â§300‚Äì600 –º—Å –ø—Ä–∏ pageSize=50 –∏ —Ç–∏–ø–æ–≤—ã—Ö —Ñ–∏–ª—å—Ç—Ä–∞—Ö.
________________________________________
6) UI/UX
6.1 –ì–ª–∞–≤–Ω–∞—è ¬´/¬ª
–§–∏–ª—å—Ç—Ä—ã (–≤–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å):
‚Ä¢	–°—Ç—Ä–∞–Ω–∞ (–∏–∑ countries, is_enabled=true),
‚Ä¢	–ë–ª–æ–∫ (–∏–∑ blocks),
‚Ä¢	–¢–∏–ø (–∏–∑ defect_types, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –±–ª–æ–∫–∞),
‚Ä¢	–ö–∞—Ç–µ–≥–æ—Ä–∏—è –ª–æ–∫–∞—Ü–∏–∏ (–∏–∑ location_categories),
‚Ä¢	–õ–æ–∫–∞—Ü–∏—è (–∏–∑ locations, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏),
‚Ä¢	–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å (–∏–∑ severity_levels),
‚Ä¢	–ü–æ–∏—Å–∫ (—Ñ—Ä–∏-—Ç–µ–∫—Å—Ç –ø–æ problem/description/solution/norm_display; –ø—Ä–∏ –≤–∫–ª—é—á—ë–Ω–Ω–æ–º pg_trgm ‚Äî —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ).
–¢–∞–±–ª–∏—Ü–∞ –¥–µ—Ñ–µ–∫—Ç–æ–≤ (–∏—Å—Ç–æ—á–Ω–∏–∫ defects_view_v2):
–∫–æ–ª–æ–Ω–∫–∏: checkbox, ID, –°—Ç—Ä–∞–Ω–∞, –ë–ª–æ–∫, –¢–∏–ø, –ü—Ä–æ–±–ª–µ–º–∞, –û–ø–∏—Å–∞–Ω–∏–µ, –†–µ—à–µ–Ω–∏–µ, –ù–æ—Ä–º–∞ (display), –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å, –ö–∞—Ç–µ–≥–æ—Ä–∏—è –ª–æ–∫–∞—Ü–∏–∏, –õ–æ–∫–∞—Ü–∏—è.
‚Ä¢	–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Å–µ–º –∫–æ–ª–æ–Ω–∫–∞–º.
‚Ä¢	–°–∫—Ä—ã—Ç–∏–µ –ø—É—Å—Ç—ã—Ö/–Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–∞—Ö.
‚Ä¢	–ü–∞–≥–∏–Ω–∞—Ü–∏—è (—Å–µ—Ä–≤–µ—Ä–Ω–∞—è): 50/100/200, —Å—Ç—Ä–µ–ª–∫–∏, ¬´–≤ –Ω–∞—á–∞–ª–æ/–≤ –∫–æ–Ω–µ—Ü¬ª, ¬´go to page N¬ª.
‚Ä¢	–ß–µ–∫–±–æ–∫—Å—ã –≤—ã–±–æ—Ä–∞ —Å—Ç—Ä–æ–∫ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage –ø–æ id).
‚Ä¢	–ö–Ω–æ–ø–∫–∏: ¬´–í—ã–±—Ä–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É / –°–Ω—è—Ç—å –≤—ã–±–æ—Ä¬ª, ¬´–í—ã–±—Ä–∞—Ç—å –≤—Å—ë (–ø–æ —Ç–µ–∫—É—â–∏–º —Ñ–∏–ª—å—Ç—Ä–∞–º)¬ª.
–ü–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π:
‚Ä¢	–≠–∫—Å–ø–æ—Ä—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö: PDF/DOCX/XLSX (–ø–æ ids –∏–∑ localStorage).
‚Ä¢	–≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º: PDF/DOCX/XLSX (—Å–µ—Ä–≤–µ—Ä —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º, –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π —Å—Ç—Ä–∞–Ω–∏—Ü).
‚Ä¢	¬´–°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤¬ª, ¬´–û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±–æ—Ä¬ª.
6.2 –î–µ—Ç–∞–ª—å–Ω–∞—è ¬´/defect/[id]¬ª
‚Ä¢	–ö–∞—Ä—Ç–æ—á–∫–∞ (read-only –¥–ª—è anon, editable –¥–ª—è authenticated):
—Å—Ç—Ä–∞–Ω–∞ (R/O), –±–ª–æ–∫ (R/O), —Ç–∏–ø (R/O), problem/description/solution (editable), –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å (select), –∫–∞—Ç–µ–≥–æ—Ä–∏—è/–ª–æ–∫–∞—Ü–∏—è (select ‚Üí –∑–∞–≤–∏—Å–∏–º—ã–π).
–ù–æ—Ä–º–∞ ‚Äî –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞—è (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç source_url).
–ö–Ω–æ–ø–∫–∞ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª (PATCH).
‚Ä¢	–ò–∑–º–µ—Ä–µ–Ω–∏—è: —Ç–∞–±–ª–∏—á–Ω—ã–π —Å–ø–∏—Å–æ–∫ (name, value, unit, created_at) + —Ñ–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è; –ø—Ä–∞–≤–∫–∞/—É–¥–∞–ª–µ–Ω–∏–µ (–¥–ª—è –∞–≤—Ç–æ—Ä–∞/authenticated).
‚Ä¢	–î–æ–±–∞–≤–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é: –ø–æ–ª–µ + –≤—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Üí insert –≤ locations, —Å—Ä–∞–∑—É –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ select.
6.3 –ì–∞–ª–µ—Ä–µ—è –º–µ–¥–∏–∞
‚Ä¢	–ò—Å—Ç–æ—á–Ω–∏–∫: media_files.
‚Ä¢	–§–∏—á–∏: —Ç–µ–≥–∏ (tags[]), –ø–æ–¥–ø–∏—Å–∏, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ/–∏–º–µ–Ω–∏, –ø–æ–∏—Å–∫ –ø–æ —Ç–µ–≥–∞–º/–∏–º–µ–Ω–∏, –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä –∏ –ø–∞–∫–µ—Ç–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ.
‚Ä¢	–ü—Ä–µ–≤—å—é (800 px) –∏ EXIF (–¥–∞—Ç–∞ —Å—ä–µ–º–∫–∏, –∫–∞–º–µ—Ä–∞ –∏ –¥—Ä.) ‚Äî —Å–º. ¬ß8.
‚Ä¢	–ü—Ä–∏–≤—è–∑–∫–∏: project_id/location_id/defect_id (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ).
6.4 –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
‚Ä¢	–í—Ö–æ–¥: Email magic-link/OTP. OAuth/SSO ‚Äî –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞ –ø–µ—Ä–≤–æ–º —ç—Ç–∞–ø–µ.
6.5 –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å
‚Ä¢	–ê–¥–∞–ø—Ç–∏–≤: –¥–µ—Å–∫—Ç–æ–ø/–ø–ª–∞–Ω—à–µ—Ç/–º–æ–±–∞–π–ª.
‚Ä¢	A11y: aria-label, —Ñ–æ–∫—É—Å-—Å—Ç–∏–ª–∏, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã.
________________________________________
7) –ü–æ–≤–µ–¥–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
‚Ä¢	–í—ã–±–æ—Ä –±–ª–æ–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç–∏–ø–æ–≤.
‚Ä¢	–í—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ª–æ–∫–∞—Ü–∏–∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –ª–æ–∫–∞—Ü–∏–∏.
‚Ä¢	–í—ã–±–æ—Ä —Å—Ç—Ä–∞–Ω—ã –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —Ç–∏–ø—ã/–ª–æ–∫–∞—Ü–∏–∏, –Ω–æ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.
‚Ä¢	–ü–æ–≤—Ç–æ—Ä—è–µ–º–æ—Å—Ç—å –¥–µ—Ñ–µ–∫—Ç–æ–≤ –ø–æ –ø–æ–º–µ—â–µ–Ω–∏—è–º ‚Äî –¥–æ–ø—É—Å—Ç–∏–º–∞; –≤—ã–≤–æ–¥ —Å—Ç—Ä–æ–∏—Ç—Å—è –ø–æ —Å—Ç—Ä–∞–Ω–µ/–±–ª–æ–∫—É/—Ç–∏–ø—É —Å —É—á—ë—Ç–æ–º –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ª–æ–∫–∞—Ü–∏–π.
________________________________________
8) –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á—ë—Ç–æ–≤
8.1 –û–±—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞
‚Ä¢	–°–µ—Ä–≤–µ—Ä–Ω—ã–µ API-—Ä–æ—É—Ç—ã Next.js —Ñ–æ—Ä–º–∏—Ä—É—é—Ç PDF/DOCX/XLSX.
‚Ä¢	–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: severity_order, country, block, type.
‚Ä¢	–õ–∏–º–∏—Ç –∑–∞—â–∏—Ç—ã: –º–∞–∫—Å–∏–º—É–º 10 000 —Å—Ç—Ä–æ–∫ –∑–∞ –æ–¥–∏–Ω —ç–∫—Å–ø–æ—Ä—Ç; –¥–ª—è –±–æ–ª—å—à–∏—Ö –Ω–∞–±–æ—Ä–æ–≤ ‚Äî ZIP-–∞—Ä—Ö–∏–≤ —Å–æ —Å–≤—è–∑–∫–∞–º–∏ (PDF + XLSX + —Å—Å—ã–ª–∫–∏ –Ω–∞ –º–µ–¥–∏–∞).
8.2 DOCX (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å —Ñ–æ—Ç–æ)
‚Ä¢	–®–∞–±–ª–æ–Ω: –ª–æ–≥–æ—Ç–∏–ø, —Ç–∏—Ç—É–ª, –æ–≥–ª–∞–≤–ª–µ–Ω–∏–µ, –∫–æ–ª–æ–Ω—Ç–∏—Ç—É–ª—ã, QR-–ø–æ–¥–ø–∏—Å—å (—Ö—ç—à/—Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –æ—Ç—á—ë—Ç–∞), —Ñ–∏—Ä–º–µ–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞.
‚Ä¢	–ü–æ –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏-–¥–µ—Ñ–µ–∫—Ç—É:
o	–∑–∞–≥–æ–ª–æ–≤–æ–∫ (–ª–æ–∫–∞—Ü–∏—è ‚Üí –∫–∞—Ç–µ–≥–æ—Ä–∏—è ‚Üí –±–ª–æ–∫/—Ç–∏–ø ‚Üí –ø—Ä–æ–±–ª–µ–º–∞),
o	—Ç–∞–±–ª–∏—Ü–∞ –ø–æ–ª–µ–π: –æ–ø–∏—Å–∞–Ω–∏–µ, —Ä–µ—à–µ–Ω–∏–µ, –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å, –Ω–æ—Ä–º–∞ (–∫–æ–¥/–ø—É–Ω–∫—Ç/–≤—ã–¥–µ—Ä–∂–∫–∞ + source_url),
o	–≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ 2‚Äì3 —Ñ–æ—Ç–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏: "media/{project_id}/{location}/{defect_id}/photos/*", —Å –ø–æ–¥–ø–∏—Å—è–º–∏ ¬´–§–æ—Ç–æ 1: ‚Ä¶¬ª.
‚Ä¢	–ü–µ—Ä–µ–Ω–æ—Å –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º, –ø–æ–≤—Ç–æ—Ä —à–∞–ø–æ–∫.
8.3 PDF
‚Ä¢	–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑ HTML —Å–µ—Ä–≤–µ—Ä–æ–º (Playwright/Puppeteer) c –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–π –≤–µ—Ä—Å—Ç–∫–æ–π (–Ω—É–º–µ—Ä–∞—Ü–∏—è, –∫–æ–ª–æ–Ω—Ç–∏—Ç—É–ª—ã, –æ–≥–ª–∞–≤–ª–µ–Ω–∏–µ).
8.4 XLSX
‚Ä¢	–õ–∏—Å—Ç data —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏ —Å–ø–∏—Å–∫–∞ + –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ª–∏—Å—Ç—ã –ø–æ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ).
________________________________________
9) API (Next.js App Router, v1)
–ë–∞–∑–æ–≤—ã–π –ø—Ä–µ—Ñ–∏–∫—Å: /api/v1
9.1 –î–µ—Ñ–µ–∫—Ç—ã/—Å–ø–∏—Å–æ–∫
GET /defects
query:
‚Ä¢	country, block, type, severity, locCat, loc, q,
‚Ä¢	sort=col:asc|desc, page, pageSize (50/100/200)
resp:
{
  "rows": [ /* –∏–∑ defects_view_v2 */ ],
  "total": 1234,
  "page": 1,
  "pageSize": 50
}
9.2 –î–µ—Ñ–µ–∫—Ç/–¥–µ—Ç–∞–ª—å
GET /defects/{id} ‚Üí –∏–∑ defects_full_v2.
PATCH /defects/{id}
body (partial):
{
  "problem": "...",
  "description": "...",
  "solution": "...",
  "severity_id": 2,
  "location_id": "uuid"
}
9.3 –ò–∑–º–µ—Ä–µ–Ω–∏—è
POST /defects/{id}/measurements
{ "name": "–ó–∞–∑–æ—Ä", "value": "3", "unit": "–º–º" }
PATCH /measurements/{id} / DELETE /measurements/{id}
9.4 –õ–æ–∫–∞—Ü–∏–∏
POST /locations
{ "category_name": "–ö–≤–∞—Ä—Ç–∏—Ä–∞", "name": "–ì–∞—Ä–¥–µ—Ä–æ–±–Ω–∞—è" }
9.5 –≠–∫—Å–ø–æ—Ä—Ç
‚Ä¢	–í—ã–±—Ä–∞–Ω–Ω—ã–µ: GET /export?format=(pdf|docx|xlsx)&ids=uuid,uuid,‚Ä¶
‚Ä¢	–ü–æ —Ñ–∏–ª—å—Ç—Ä–∞–º: GET /export?format=‚Ä¶&all=true&country=‚Ä¶&block=‚Ä¶&‚Ä¶
–ü–æ–≤–µ–¥–µ–Ω–∏–µ: —Å–µ—Ä–≤–µ—Ä –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –≤—ã–±–æ—Ä–∫—É –∫–∞–∫ /defects, –Ω–æ –±–µ–∑ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏; —Ä–µ–Ω–¥–µ—Ä–∏—Ç —Ñ–∞–π–ª; –æ—Ç–≤–µ—Ç application/octet-stream —Å Content-Disposition: attachment.
9.6 –ú–µ–¥–∏–∞/–ø–æ–∏—Å–∫
GET /media/search
query: q (–∏–º—è), tag, date_from, date_to, project_id, defect_id, location_id.
resp: –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ media_files + Signed URLs (—á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–∫—Å–∏-—Ä–æ—É—Ç).
9.7 –í–µ–±—Ö—É–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
‚Ä¢	POST /webhooks/report-ready ‚Äî –æ—Ç—á—ë—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ).
‚Ä¢	POST /webhooks/new-measurement, ‚Ä¶/new-location ‚Äî —Å–æ–±—ã—Ç–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è.
–û—à–∏–±–∫–∏ API: JSON { "error": { "code": "‚Ä¶", "message": "‚Ä¶" } }, –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ HTTP-–∫–æ–¥—ã.
________________________________________
10) –ú–µ–¥–∏–∞-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ (Supabase Storage)
10.1 –ë–∞–∫–µ—Ç –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
‚Ä¢	–ë–∞–∫–µ—Ç: media
‚Ä¢	–ü–∞–ø–∫–∏: media/{project_id}/{location}/{defect_id}/{photos|videos|docs}/filename.ext
10.2 Signed URLs + –ø—Ä–æ–∫—Å–∏
‚Ä¢	–î–æ—Å—Ç—É–ø –º–µ–¥–∏–∞ ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ Signed URL (TTL –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π), –≤—ã–¥–∞—ë—Ç —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–∫—Å–∏; –ø—Ä—è–º—ã–µ –ø—É—Ç–∏ –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞—é—Ç—Å—è.
10.3 –ü—Ä–µ–≤—å—é/EXIF (–ø–æ—è—Å–Ω–µ–Ω–∏–µ)
‚Ä¢	–ü—Ä–µ–≤—å—é ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —É–º–µ–Ω—å—à–µ–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (‚âà800 px –ø–æ –¥–ª–∏–Ω–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω–µ) –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –≥–∞–ª–µ—Ä–µ–∏; —Ö—Ä–∞–Ω–∏—Ç—Å—è –ø—É—Ç—å preview_path.
‚Ä¢	EXIF ‚Äî –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (–¥–∞—Ç–∞/–≤—Ä–µ–º—è —Å—ä–µ–º–∫–∏, –∫–∞–º–µ—Ä–∞, –≥–µ–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏) –≤ –ø–æ–ª–µ exif (jsonb). –≠—Ç–æ –Ω–µ ¬´–æ–±—è–∑–∞–ª–æ–≤–∫–∞¬ª, –Ω–æ —Å–∏–ª—å–Ω–æ —É—Å–∫–æ—Ä—è–µ—Ç –ø–æ–∏—Å–∫/—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –∏ –ø–æ–≤—ã—à–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ—Å—Ç—å —Ñ–æ—Ç–æ-–≤—Å—Ç–∞–≤–æ–∫ –≤ –æ—Ç—á—ë—Ç.
‚Ä¢	–¢–µ–≥–∏ ‚Äî tags[] (–Ω–∞–ø—Ä–∏–º–µ—Ä: ["—Ç—Ä–µ—â–∏–Ω–∞","–æ–∫–Ω–æ","—Ä–∞–¥–∏–∞—Ç–æ—Ä"]), —É—á–∞—Å—Ç–≤—É—é—Ç –≤ –ø–æ–∏—Å–∫–µ.
‚Ä¢	–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤: ¬´–∂—ë—Å—Ç–∫–æ–≥–æ¬ª –º–∞–∫—Å–∏–º—É–º–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è (–ø–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—é). –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ >25 –ú–ë (UX).
________________________________________
11) PWA –∏ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º
‚Ä¢	–ú–∞–Ω–∏—Ñ–µ—Å—Ç + —Å–µ—Ä–≤–∏—Å-–≤–æ—Ä–∫–µ—Ä.
‚Ä¢	–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ GET-–∑–∞–ø—Ä–æ—Å–æ–≤ –∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ –≤ IndexedDB (countries/blocks/types/norms/severity/locations).
‚Ä¢	Background Sync: –æ—á–µ—Ä–µ–¥—å POST-–æ–ø–µ—Ä–∞—Ü–∏–π (–∏–∑–º–µ—Ä–µ–Ω–∏—è, –Ω–æ–≤—ã–µ –ª–æ–∫–∞—Ü–∏–∏, –º–µ–¥–∏–∞-–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ).
‚Ä¢	–°—Ç–∞—Ç—É—Å—ã –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ: ¬´–≤ –æ—á–µ—Ä–µ–¥–∏¬ª ‚Üí ¬´–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ¬ª; –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–µ—Ç–∏.
‚Ä¢	–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤: –ø—Ä–∏ –Ω–µ—É—Å–ø–µ—Ö–µ PATCH ‚Äî —è–≤–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ—Å—Ç ¬´–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞/–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É¬ª.
________________________________________
12) –ù–µ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
‚Ä¢	–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: –æ—Ç–≤–µ—Ç —Å–ø–∏—Å–∫–∞ ‚â§300‚Äì600 –º—Å –Ω–∞ 50 —Å—Ç—Ä–æ–∫ –ø—Ä–∏ —Ç–∏–ø–æ–≤—ã—Ö —Ñ–∏–ª—å—Ç—Ä–∞—Ö; —Å–µ—Ä–≤–µ—Ä–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç –±–æ–ª—å—à–∏—Ö –Ω–∞–±–æ—Ä–æ–≤.
‚Ä¢	–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å: —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ API; —Ä–µ—Ç—Ä–∞–∏ –≤ —ç–∫—Å–ø–æ—Ä—Ç–µ; –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –æ—Ç—á—ë—Ç–∞.
‚Ä¢	–õ–æ–≥–∏/–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: Sentry (frontend/backend), Logflare/pg_audit; —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.
‚Ä¢	–ë—ç–∫–∞–ø—ã: —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ snapshots –ë–î –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ (+ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å ¬´—Ä—É—á–Ω–æ–≥–æ¬ª snapshot).
‚Ä¢	–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
o	—Ç–æ–ª—å–∫–æ –ø—É–±–ª–∏—á–Ω—ã–µ –∫–ª—é—á–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ;
o	–≤—Å—è –∑–∞–ø–∏—Å—å ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è authenticated —á–µ—Ä–µ–∑ RLS;
o	–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–ª—è –∞–Ω–æ–Ω–∏–º–∞ (–±–µ–∑ ¬´–≤—ã–±—Ä–∞—Ç—å –≤—Å—ë¬ª);
o	rate-limit –≤ API –º–æ–∂–Ω–æ –æ–ø—É—Å—Ç–∏—Ç—å –Ω–∞ –ø–µ—Ä–≤–æ–º —ç—Ç–∞–ø–µ (1 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å), –Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –≤–∫–ª—é—á–∏—Ç—å.
________________________________________
13) –ò–º–ø–æ—Ä—Ç/—Å–∏–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
‚Ä¢	–ò—Å—Ö–æ–¥–Ω—ã–µ –º–∞—Å—Ç–µ—Ä-—Ñ–∞–π–ª—ã: CSV/Excel (—Å—Ç—Ä–∞–Ω—ã, –±–ª–æ–∫–∏/—Ç–∏–ø—ã, –ª–æ–∫–∞—Ü–∏–∏, –Ω–æ—Ä–º—ã, –¥–µ—Ñ–µ–∫—Ç—ã).
‚Ä¢	–ü–æ—Ä—è–¥–æ–∫ –∏–º–ø–æ—Ä—Ç–∞:
1.	countries, blocks, severity_levels, location_categories
2.	defect_types (map: block_name ‚Üí blocks.name)
3.	locations (map: category_name ‚Üí location_categories.name)
4.	norms (map: country_name)
5.	defects (map –ø–æ –∏–º–µ–Ω–∞–º –∏ norm code+point, –¥–µ–¥—É–ø –ø–æ –∏–Ω–¥–µ–∫—Å—É)
6.	defect_measurements (–ø–æ defect_id –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏ –¥–µ—Ñ–µ–∫—Ç–æ–≤)
‚Ä¢	–û–±—ä—ë–º –Ω–∞ –∑–∞–ø—É—Å–∫: ‚âà500 –¥–µ—Ñ–µ–∫—Ç–æ–≤/—Å—Ç—Ä–∞–Ω–∞, –≤–æ–∑–º–æ–∂–Ω—ã–π —Ä–æ—Å—Ç –Ω–µ –±–æ–ª–µ–µ √ó2.
‚Ä¢	–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –ø–æ–ª–Ω—ã–π server_seed_full.sql: —Å–æ–∑–¥–∞—ë—Ç —Å—Ö–µ–º—É/–≤—å—é—Ö–∏/RLS –∏ —Ñ—É–Ω–∫—Ü–∏–∏ upsert_* (—Å—Ç—Ä–∞–Ω–∞, –±–ª–æ–∫, —Ç–∏–ø, –ª–æ–∫–∞—Ü–∏—è, –Ω–æ—Ä–º–∞, –¥–µ—Ñ–µ–∫—Ç).
‚Ä¢	(–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) \copy-—Å–∫—Ä–∏–ø—Ç –∏–ª–∏ Node-—É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ upsert_defect(...) –ø–æ CSV.
________________________________________
14) –î–µ–ø–ª–æ–π/–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
‚Ä¢	–õ–æ–∫–∞–ª—å–Ω–æ–µ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ (Docker/–í–ú/–ü–ö/–Ω–æ—É—Ç–±—É–∫).
‚Ä¢	Node.js: –∞–∫—Ç—É–∞–ª—å–Ω–∞—è LTS (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º 20.x).
‚Ä¢	–î–æ–º–µ–Ω/HTTPS/CDN: –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è –Ω–∞ –ø–µ—Ä–≤–æ–º —ç—Ç–∞–ø–µ.
‚Ä¢	Azure ‚Äî –∫–∞–∫ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ–≤–º–µ—Å—Ç–∏–º–∞.
‚Ä¢	Supabase Storage: –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å CORS –∏ –ø–æ–ª–∏—Ç–∏–∫—É Signed URLs.
________________________________________
15) –õ–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–ª–∏—Ç–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö
‚Ä¢	–õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–µ –ø–ª–∞–Ω—ã/–ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π –¥–æ—Å—Ç—É–ø ‚Äî –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è –Ω–∞ –ø–µ—Ä–≤–æ–º —ç—Ç–∞–ø–µ.
‚Ä¢	–ü–æ–ª–∏—Ç–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö:
o	—Ä–µ–≥–∏–æ–Ω —Ö—Ä–∞–Ω–µ–Ω–∏—è ‚Äî –ø–æ —Ä–µ–≥–∏–æ–Ω—É Supabase –ø—Ä–æ–µ–∫—Ç–∞;
o	–ø—Ä–∞–≤–æ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ/—ç–∫—Å–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö;
o	–æ—Ç—á—ë—Ç—ã/–º–µ–¥–∏–∞ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Supabase (Retention ‚Äî –ø–æ —É—Å–º–æ—Ç—Ä–µ–Ω–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è).
________________________________________
16) –ü—Ä–∏—ë–º–æ—á–Ω—ã–µ —Ç–µ—Å—Ç—ã (Acceptance)
–î–∞–Ω–Ω—ã–µ/–∏–º–ø–æ—Ä—Ç
‚Ä¢	–ò–º–ø–æ—Ä—Ç –º–∏–≥—Ä–∞—Ü–∏–π –∏ CSV ‚Üí –∑–∞–ø–∏—Å–∏ –≤–∏–¥–Ω—ã –≤–æ defects_full_v2/defects_view_v2.
‚Ä¢	–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è: –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ —Å–æ–∑–¥–∞—ë—Ç –¥—É–±–ª–µ–π.
–§–∏–ª—å—Ç—Ä—ã/—Å–ø–∏—Å–æ–∫
‚Ä¢	–§–∏–ª—å—Ç—Ä—ã –ø–æ —Å—Ç—Ä–∞–Ω–µ/–±–ª–æ–∫—É/—Ç–∏–ø—É —Ä–∞–±–æ—Ç–∞—é—Ç; —Ç–∏–ø –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –±–ª–æ–∫–∞;
‚Ä¢	–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Å–µ–º —Å—Ç–æ–ª–±—Ü–∞–º; –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è ¬´–Ω–µ –º–µ—à–∞—é—Ç¬ª.
‚Ä¢	–ü–∞–≥–∏–Ω–∞—Ü–∏—è 50/100/200; ¬´–≤—ã–±—Ä–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É/–≤—Å—ë¬ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤—ã–±–æ—Ä–æ–º.
–î–µ—Ç–∞–ª—å –¥–µ—Ñ–µ–∫—Ç–∞
‚Ä¢	–ú–æ–∂–Ω–æ –ø—Ä–∏—Å–≤–æ–∏—Ç—å –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å, –∫–∞—Ç–µ–≥–æ—Ä–∏—é/–ª–æ–∫–∞—Ü–∏—é, –ø—Ä–∞–≤–∏—Ç—å problem/description/solution.
‚Ä¢	–ò–∑–º–µ—Ä–µ–Ω–∏—è: –¥–æ–±–∞–≤–∏—Ç—å/–ø—Ä–∞–≤–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å; created_at —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è.
‚Ä¢	¬´–î–æ–±–∞–≤–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é¬ª ‚Äî –∑–∞–ø–∏—Å—å –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ —Å–µ–ª–µ–∫—Ç–µ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏.
–≠–∫—Å–ø–æ—Ä—Ç
‚Ä¢	¬´–í—ã–±—Ä–∞–Ω–Ω—ã–µ¬ª ‚Üí —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏;
‚Ä¢	¬´–ü–æ —Ñ–∏–ª—å—Ç—Ä–∞–º¬ª ‚Üí —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ —Å—Ç—Ä–æ–∫–∏, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É;
‚Ä¢	DOCX —Å–æ–¥–µ—Ä–∂–∏—Ç 2‚Äì3 —Ñ–æ—Ç–æ –ø–æ–¥ –¥–µ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏; –Ω–æ—Ä–º—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è (–∫–æ–¥/–ø—É–Ω–∫—Ç/–≤—ã–¥–µ—Ä–∂–∫–∞/—Å—Å—ã–ª–∫–∞).
–ì–∞–ª–µ—Ä–µ—è
‚Ä¢	–¢–µ–≥–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –∏ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –≤ –ø–æ–∏—Å–∫–µ; –ø—Ä–µ–≤—å—é –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è; –ø–∞–∫–µ—Ç–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç.
PWA/–æ—Ñ–ª–∞–π–Ω
‚Ä¢	–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ;
‚Ä¢	–ö—ç—à —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ –≤ IndexedDB;
‚Ä¢	–û—á–µ—Ä–µ–¥—å Background Sync: —Å—Ç–∞—Ç—É—Å—ã ¬´–≤ –æ—á–µ—Ä–µ–¥–∏/–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ¬ª, –∞–≤—Ç–æ-—Ä–µ—Ç—Ä–∞–∏.
–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å/RLS
‚Ä¢	anon ‚Äî —Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ; authenticated ‚Äî –∑–∞–ø–∏—Å—å —Å–æ–≥–ª–∞—Å–Ω–æ –ø–æ–ª–∏—Ç–∏–∫–µ;
‚Ä¢	–ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ Storage –±–µ–∑ Signed URL –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.
–°–º–æ—É–∫-—Ç–µ—Å—Ç—ã –∏ E2E
‚Ä¢	–°–º–æ—É–∫ PWA/–æ—Ñ–ª–∞–π–Ω;
‚Ä¢	E2E (Playwright): —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Å–ø–∏—Å–∫–∞, —Ñ–∏–ª—å—Ç—Ä–æ–≤, —ç–∫—Å–ø–æ—Ä—Ç–∞, –¥–µ—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏, –∏–∑–º–µ—Ä–µ–Ω–∏–π, –º–µ–¥–∏–∞.
________________________________________
17) –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
‚Ä¢	–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø—Ä–µ—Å–µ—Ç—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ).
‚Ä¢	–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–∞–≤–æ–∫/–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (audit trail).
‚Ä¢	–ò–º–ø–æ—Ä—Ç CSV –∏–∑ UI –¥–ª—è –∞–¥–º–∏–Ω–∞.
‚Ä¢	–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏/–∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –≤ –æ—Ç—á—ë—Ç–∞—Ö (–ø–æ –±–ª–æ–∫–∞–º/—Ç–∏–ø–∞–º/–ª–æ–∫–∞—Ü–∏—è–º).
‚Ä¢	–ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å (EN).
‚Ä¢	–ú—É–ª—å—Ç–∏-—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç—å/—Ä–æ–ª–∏ ¬´–º–µ–Ω–µ–¥–∂–µ—Ä/—Ä–µ–≤—å—é–µ—Ä¬ª –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º.
________________________________________
18) –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚Ä¢	–°–ø–∏—Å–æ–∫ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤ –∏ –ø—Ä–∏–º–µ—Ä—ã —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫ ‚Äî –∑–∞–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è –≤ norms —Å code, point, source_url, full_text.
‚Ä¢	DOCX-—à–∞–±–ª–æ–Ω: —Ç–∏—Ç—É–ª —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º, –æ–≥–ª–∞–≤–ª–µ–Ω–∏–µ, –∫–æ–ª–æ–Ω—Ç–∏—Ç—É–ª—ã, QR-–ø–æ–¥–ø–∏—Å—å; —Ä–∞–∑–¥–µ–ª—ã ¬´–î–∞–Ω–Ω—ã–µ –æ–± –æ–±—ä–µ–∫—Ç–µ¬ª, ¬´–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã¬ª, ¬´–ù–æ—Ä–º–∞—Ç–∏–≤–Ω–æ-–ø—Ä–∞–≤–æ–≤–∞—è –±–∞–∑–∞¬ª, ¬´–§–æ—Ç–æ–æ—Ç—á—ë—Ç¬ª –∏ –¥—Ä.
‚Ä¢	–ú–µ–¥–∏–∞-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞: media/{project_id}/{location}/{defect_id}/{photos|videos|docs}/‚Ä¶
‚ÄÉ
–ù–∏–∂–µ –ø—Ä–∏–≤–æ–∂—É –ø–æ–ª–Ω—ã–π server_seed_full.sql –¥–ª—è Supabase/Postgres ‚Äî –≤ —Ç–æ–º –≤–∏–¥–µ, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –µ–≥–æ –≤ SQL Editor Supabase (–ø–æ–¥ service_role) –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —á–µ—Ä–µ–∑ psql.
–§–∞–π–ª —Å–æ–∑–¥–∞—ë—Ç:
‚Ä¢	–≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã (countries, blocks, defect_types, norms, severity_levels, location_categories, locations, defects, defect_measurements, media_files, import_logs),
‚Ä¢	–≤—Å–µ –≤—å—é—Ö–∏ (defects_full_v2, defects_view_v2),
‚Ä¢	–≤–∫–ª—é—á–∞–µ—Ç RLS + –ø–æ–ª–∏—Ç–∏–∫–∏ —á—Ç–µ–Ω–∏—è/–∑–∞–ø–∏—Å–∏,
‚Ä¢	–≤—Å—Ç–∞–≤–ª—è–µ—Ç —Å–∏–¥—ã –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏,
‚Ä¢	–¥–æ–±–∞–≤–ª—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ upsert_* –¥–ª—è —Å–ª–æ–≤–∞—Ä–µ–π, –Ω–æ—Ä–º –∏ –¥–µ—Ñ–µ–∫—Ç–æ–≤.
________________________________________
-- server_seed_full.sql
-- –ü–æ–ª–Ω—ã–π —Å–∏–¥–∏–Ω–≥ —Å—Ö–µ–º—ã –∏ —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è Supabase/Postgres
-- –í–ê–ñ–ù–û: –∑–∞–ø—É—Å–∫–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ–¥ service_role, –≤ –±—Ä–∞—É–∑–µ—Ä–µ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å!

begin;

-- Extensions -----------------------------------------------------------------
create extension if not exists "uuid-ossp";
create extension if not exists pgcrypto;

-- –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ ---------------------------------------------------------------
create table if not exists countries(
  id uuid primary key default gen_random_uuid(),
  name text unique not null,
  is_enabled boolean not null default true
);

create table if not exists blocks(
  id uuid primary key default gen_random_uuid(),
  name text unique not null
);

create table if not exists defect_types(
  id uuid primary key default gen_random_uuid(),
  block_id uuid not null references blocks(id) on delete cascade,
  name text not null,
  unique(block_id, name)
);

create table if not exists norms(
  id uuid primary key default gen_random_uuid(),
  country_id uuid not null references countries(id) on delete cascade,
  code text not null,
  point text not null,
  source_url text,
  full_text text,
  unique(country_id, code, point)
);

create table if not exists severity_levels(
  id bigserial primary key,
  name text unique not null,
  sort_order int not null
);

create table if not exists location_categories(
  id uuid primary key default gen_random_uuid(),
  name text unique not null
);

create table if not exists locations(
  id uuid primary key default gen_random_uuid(),
  category_id uuid not null references location_categories(id) on delete cascade,
  name text not null,
  unique(category_id, name)
);

-- –î–µ—Ñ–µ–∫—Ç—ã -------------------------------------------------------------------
create table if not exists defects(
  id uuid primary key default gen_random_uuid(),
  country_id uuid not null references countries(id),
  block_id uuid not null references blocks(id),
  type_id uuid not null references defect_types(id),
  problem text not null,
  description text,
  solution text,
  norm_id uuid references norms(id),
  severity_id bigint references severity_levels(id),
  location_id uuid references locations(id),
  created_at timestamptz not null default now()
);

create unique index if not exists defects_dedupe_idx
on defects(country_id, block_id, type_id, problem, coalesce(norm_id,'00000000-0000-0000-0000-000000000000'));

-- –ò–∑–º–µ—Ä–µ–Ω–∏—è -----------------------------------------------------------------
create table if not exists defect_measurements(
  id bigserial primary key,
  defect_id uuid not null references defects(id) on delete cascade,
  name text not null,
  value text,
  unit text,
  created_at timestamptz not null default now(),
  created_by uuid
);

-- –ú–µ–¥–∏–∞ ---------------------------------------------------------------------
create table if not exists media_files(
  id uuid primary key default gen_random_uuid(),
  project_id uuid,
  defect_id uuid references defects(id) on delete set null,
  location_id uuid references locations(id) on delete set null,
  path text not null,
  preview_path text,
  exif jsonb,
  tags text[],
  created_at timestamptz not null default now()
);

-- –õ–æ–≥–∏ –∏–º–ø–æ—Ä—Ç–∞ ---------------------------------------------------------------
create table if not exists import_logs(
  id bigserial primary key,
  source text,
  rows int,
  started_at timestamptz default now(),
  finished_at timestamptz,
  details jsonb
);

-- –í—å—é—Ö–∏ ---------------------------------------------------------------------
create or replace view defects_full_v2 as
select d.*,
       c.name as country_name,
       b.name as block_name,
       t.name as type_name,
       l.name as location_name,
       lc.name as location_category_name,
       n.code as norm_code,
       n.point as norm_point,
       n.source_url as norm_source_url,
       n.full_text as norm_full_text,
       s.name as severity_name,
       s.sort_order as severity_order,
       (coalesce(n.code,'') || ' ' || coalesce(n.point,'')) as norm_display
from defects d
join countries c on c.id = d.country_id
join blocks b on b.id = d.block_id
join defect_types t on t.id = d.type_id
left join locations l on l.id = d.location_id
left join location_categories lc on lc.id = l.category_id
left join norms n on n.id = d.norm_id
left join severity_levels s on s.id = d.severity_id;

create or replace view defects_view_v2 as
select id, country_id, block_id, type_id, problem, description, solution,
       norm_id, severity_id, location_id,
       country_name, block_name, type_name,
       location_category_name, location_name,
       norm_display, severity_order
from defects_full_v2;

-- RLS -----------------------------------------------------------------------
alter table countries enable row level security;
alter table blocks enable row level security;
alter table defect_types enable row level security;
alter table norms enable row level security;
alter table severity_levels enable row level security;
alter table location_categories enable row level security;
alter table locations enable row level security;
alter table defects enable row level security;
alter table defect_measurements enable row level security;
alter table media_files enable row level security;

-- –ü–æ–ª–∏—Ç–∏–∫–∏ select –¥–ª—è anon/authenticated
create policy if not exists "read_all_countries" on countries for select using (true);
create policy if not exists "read_all_blocks" on blocks for select using (true);
create policy if not exists "read_all_types" on defect_types for select using (true);
create policy if not exists "read_all_norms" on norms for select using (true);
create policy if not exists "read_all_severity" on severity_levels for select using (true);
create policy if not exists "read_all_loc_cat" on location_categories for select using (true);
create policy if not exists "read_all_locations" on locations for select using (true);
create policy if not exists "read_all_defects" on defects for select using (true);
create policy if not exists "read_all_measurements" on defect_measurements for select using (true);
create policy if not exists "read_all_media" on media_files for select using (true);

-- –ü–æ–ª–∏—Ç–∏–∫–∏ –∑–∞–ø–∏—Å–∏ –¥–ª—è authenticated
create policy if not exists "auth_upd_defects" on defects for update to authenticated using (true);
create policy if not exists "auth_insupd_measurements" on defect_measurements for all to authenticated using (true) with check (true);
create policy if not exists "auth_ins_locations" on locations for insert to authenticated with check (true);
create policy if not exists "auth_ins_media" on media_files for insert to authenticated with check (true);

-- Seed –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏ -----------------------------------------------------------
insert into severity_levels(name, sort_order) values
  ('–ö—Ä–∏—Ç–∏—á–Ω–æ',1),
  ('–°—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ',2),
  ('–ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ',3),
  ('–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ',4)
on conflict (name) do update set sort_order=excluded.sort_order;

-- –§—É–Ω–∫—Ü–∏–∏ upsert -------------------------------------------------------------
create or replace function upsert_country(p_name text, p_enabled boolean default true)
returns uuid language plpgsql as $$
declare v_id uuid;
begin
  insert into countries(name, is_enabled) values (p_name, coalesce(p_enabled,true))
  on conflict(name) do update set is_enabled=excluded.is_enabled
  returning id into v_id;
  return v_id;
end $$;

create or replace function upsert_block(p_name text)
returns uuid language plpgsql as $$
declare v_id uuid;
begin
  insert into blocks(name) values (p_name)
  on conflict(name) do update set name=excluded.name
  returning id into v_id;
  return v_id;
end $$;

create or replace function upsert_type(p_block text, p_type text)
returns uuid language plpgsql as $$
declare v_bid uuid; v_tid uuid;
begin
  v_bid := upsert_block(p_block);
  insert into defect_types(block_id, name) values(v_bid, p_type)
  on conflict(block_id,name) do update set name=excluded.name
  returning id into v_tid;
  return v_tid;
end $$;

create or replace function upsert_loc_category(p_name text)
returns uuid language plpgsql as $$
declare v_id uuid;
begin
  insert into location_categories(name) values (p_name)
  on conflict(name) do update set name=excluded.name
  returning id into v_id;
  return v_id;
end $$;

create or replace function upsert_location(p_cat text, p_loc text)
returns uuid language plpgsql as $$
declare v_cid uuid; v_lid uuid;
begin
  v_cid := upsert_loc_category(p_cat);
  insert into locations(category_id, name) values (v_cid, p_loc)
  on conflict(category_id,name) do update set name=excluded.name
  returning id into v_lid;
  return v_lid;
end $$;

create or replace function upsert_norm(p_country text, p_code text, p_point text, p_url text, p_full text)
returns uuid language plpgsql as $$
declare v_cid uuid; v_nid uuid;
begin
  v_cid := upsert_country(p_country, true);
  insert into norms(country_id, code, point, source_url, full_text)
  values (v_cid, p_code, p_point, p_url, p_full)
  on conflict(country_id, code, point) do update set
    source_url = excluded.source_url,
    full_text = excluded.full_text
  returning id into v_nid;
  return v_nid;
end $$;

create or replace function upsert_defect(
  p_country text,
  p_block text,
  p_type text,
  p_problem text,
  p_description text,
  p_solution text,
  p_norm_code text,
  p_norm_point text,
  p_severity text,
  p_loc_cat text,
  p_location text
) returns uuid language plpgsql as $$
declare
  v_cid uuid;
  v_bid uuid;
  v_tid uuid;
  v_sid bigint;
  v_lid uuid;
  v_nid uuid;
  v_id uuid;
begin
  v_cid := upsert_country(p_country, true);
  v_tid := upsert_type(p_block, p_type);
  select block_id into v_bid from defect_types where id=v_tid;
  if p_loc_cat is not null and p_location is not null then
    v_lid := upsert_location(p_loc_cat, p_location);
  end if;
  if p_norm_code is not null and p_norm_point is not null then
    v_nid := upsert_norm(p_country, p_norm_code, p_norm_point, null, null);
  end if;
  if p_severity is not null then
    select id into v_sid from severity_levels where name = p_severity;
  end if;

  insert into defects(country_id, block_id, type_id, problem, description, solution, norm_id, severity_id, location_id)
  values (v_cid, v_bid, v_tid, p_problem, p_description, p_solution, v_nid, v_sid, v_lid)
  on conflict (country_id, block_id, type_id, problem, coalesce(norm_id,'00000000-0000-0000-0000-000000000000'))
  do update set description = excluded.description, solution = excluded.solution, severity_id = excluded.severity_id, location_id = excluded.location_id
  returning id into v_id;
  return v_id;
end $$;

commit;
________________________________________
üìå –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:
1.	–í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –≤ Supabase SQL Editor –∏–ª–∏ psql –ø–æ–¥ service_role.
2.	–î–ª—è –ø–∞–∫–µ—Ç–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ CSV –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ \copy + –≤—ã–∑–æ–≤—ã upsert_defect(...) –ø–æ —Å—Ç—Ä–æ–∫–∞–º.
3.	–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –≤—å—é—Ö–∏ defects_full_v2 –∏ defects_view_v2 –±—É–¥—É—Ç –≥–æ—Ç–æ–≤—ã –¥–ª—è UI.
4.	RLS –≤–∫–ª—é—á–µ–Ω—ã ‚Äî –¥–æ—Å—Ç—É–ø anon/authenticated –æ–≥—Ä–∞–Ω–∏—á–µ–Ω —Å–æ–≥–ª–∞—Å–Ω–æ –ø–æ–ª–∏—Ç–∏–∫–∞–º.

‚ÄÉ
